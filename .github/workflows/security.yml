name: DevSecOps Pipeline (SAST + DAST + Reports)

on:
  push:
    branches: [ "main" ]
  pull_request:

jobs:
  sast_semgrep:
    name: SAST - Semgrep (SARIF Report)
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Run Semgrep -> SARIF
        uses: returntocorp/semgrep-action@v1
        with:
          config: p/security-audit
          generateSarif: "1"

      - name: Save Semgrep SARIF
        run: |
          mkdir -p reports
          cp semgrep.sarif reports/semgrep.sarif

      - name: Upload Semgrep SARIF to GitHub Security
        uses: github/codeql-action/upload-sarif@v3
        with:
          sarif_file: reports/semgrep.sarif

      - name: Upload reports artifact (Semgrep)
        uses: actions/upload-artifact@v4
        with:
          name: reports-semgrep
          path: reports/semgrep.sarif

  dast_trivy:
    name: DAST - Trivy (Reports)
    runs-on: ubuntu-latest
    needs: [sast_semgrep]
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Trivy FS Secrets -> JSON + SARIF
        uses: aquasecurity/trivy-action@0.24.0
        with:
          scan-type: fs
          scanners: secret
          format: sarif
          output: reports/trivy-secrets.sarif
          exit-code: "1"

      - name: Trivy FS Secrets -> JSON (extra)
        run: |
          mkdir -p reports
          docker run --rm -v "$PWD:/work" -w /work aquasec/trivy:latest fs \
            --scanners secret --format json --output reports/trivy-secrets.json .

      - name: Upload Trivy SARIF to GitHub Security
        uses: github/codeql-action/upload-sarif@v3
        with:
          sarif_file: reports/trivy-secrets.sarif

      - name: Upload reports artifact (Trivy)
        uses: actions/upload-artifact@v4
        with:
          name: reports-trivy
          path: reports/
