name: DevSecOps Pipeline (SAST + DAST + Reports)

on:
  push:
    branches: [ "main" ]
  pull_request:

# Permisos necesarios para subir SARIF a "Security"
permissions:
  contents: read
  security-events: write
  actions: read

jobs:
  sast_semgrep:
    name: SAST - Semgrep (SARIF Report)
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install Semgrep
        run: |
          python -m pip install --upgrade pip
          pip install semgrep

      - name: Run Semgrep -> SARIF
        run: |
          mkdir -p reports
          semgrep scan --config p/security-audit --sarif --output reports/semgrep.sarif .

      # Subir SARIF a GitHub Security (solo en push, para evitar bloqueos en PR)
      - name: Upload Semgrep SARIF to GitHub Security
        if: github.event_name == 'push'
        uses: github/codeql-action/upload-sarif@v3
        with:
          sarif_file: reports/semgrep.sarif

      - name: Upload Semgrep report artifact
        uses: actions/upload-artifact@v4
        with:
          name: reports-semgrep
          path: reports/semgrep.sarif

  dast_trivy:
    name: DAST - Trivy (Reports)
    runs-on: ubuntu-latest
    needs: [sast_semgrep]
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Trivy Secret Scan -> SARIF (fails on findings)
        uses: aquasecurity/trivy-action@0.24.0
        with:
          scan-type: fs
          scanners: secret
          format: sarif
          output: reports/trivy-secrets.sarif
          exit-code: "1"

      - name: Upload Trivy SARIF to GitHub Security
        if: github.event_name == 'push'
        uses: github/codeql-action/upload-sarif@v3
        with:
          sarif_file: reports/trivy-secrets.sarif

      - name: Upload Trivy reports artifact
        uses: actions/upload-artifact@v4
        with:
          name: reports-trivy
          path: reports/
